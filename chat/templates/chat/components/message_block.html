{% comment %}
Этот data-message-id="{
    { message.id }}" КРИТИЧЕСКИ ВАЖЕН.
{% endcomment %}
<div class="message flex gap-4 mb-6 animate-fade-in {% if message.role == 'user' %}flex-row-reverse{% endif %}" data-message-id="{{ message.id }}">

    <!-- АВАТАР -->
    <div class="flex-shrink-0 w-9 h-9 rounded-full flex items-center justify-center shadow-sm border border-gray-100 overflow-hidden
        {% if message.role == 'user' %} bg-[#8B1538] text-white {% else %} bg-white text-[#8B1538] border-2 border-[#8B1538] {% endif %}">
        {% if message.role == 'user' %}
            <!-- Юзер (Белая иконка) -->
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        {% else %}
            <!-- ИИ (Красная искорка) -->
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" /><path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 2 -2" /><path d="M19 11h2m-1 -1v2" /></svg>
        {% endif %}
    </div>

    <!-- КОНТЕНТ -->
    <div class="flex-1 max-w-[85%] {% if message.role == 'user' %}text-right{% endif %}">
        <div class="px-6 py-4 rounded-2xl text-left shadow-sm border
            {% if message.role == 'user' %}
                bg-[#8B1538] border-transparent text-white rounded-tr-sm inline-block
            {% else %}
                bg-white border-gray-200 text-gray-800 rounded-tl-sm
                {% if message.data_payload.plotly_json %} w-full block {% else %} inline-block {% endif %}
            {% endif %}">

            <!-- ТЕКСТ -->
            {% if message.role == 'ai' %}
                <div class="markdown-content prose max-w-none">{{ message.content }}</div>
            {% else %}
                <div class="whitespace-pre-wrap font-medium">{{ message.content }}</div>
            {% endif %}

            <!-- ДЕЙСТВИЯ (Только для AI) -->
            {% if message.role == 'ai' and message.data_payload.sql_query %}
                <div class="message-actions not-prose">
                    <details class="group relative">
                        <summary class="cursor-pointer text-xs font-medium text-gray-400 hover:text-[#8B1538] flex items-center gap-1 select-none list-none transition-colors">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                            SQL Запрос
                        </summary>
                        <div class="mt-3 w-full bg-[#1a0a0f] text-gray-200 p-4 rounded-xl shadow-inner text-xs font-mono overflow-x-auto border border-[#2f1c23]">
                            {{ message.data_payload.sql_query }}
                        </div>
                    </details>

                    <a href="{% url 'download_excel' message.id %}" class="excel-btn" target="_blank">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                        Скачать Excel
                    </a>

                    <!-- Лайки -->
                    <div class="flex items-center gap-1 ml-auto border-l border-gray-200 pl-3">
                        <button class="rate-btn p-1.5 rounded-lg hover:bg-gray-100 text-gray-400 transition-colors {% if message.feedback == True %}text-green-600 bg-green-50{% endif %}"
                                data-id="{{ message.id }}" data-vote="up" title="Хороший ответ">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>
                        </button>
                        <button class="rate-btn p-1.5 rounded-lg hover:bg-gray-100 text-gray-400 transition-colors {% if message.feedback == False %}text-red-600 bg-red-50{% endif %}"
                                data-id="{{ message.id }}" data-vote="down" title="Плохой ответ">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>
                        </button>
                    </div>
                </div>
            {% endif %}

            <!-- ГРАФИК -->
            {% if message.role == 'ai' and message.data_payload.plotly_json %}
                <div class="bot-chart chart-container-placeholder mt-5 not-prose w-full shadow-sm"
                     id="chart-{{ message.id }}"
                     data-plotly-json="{{ message.data_payload.plotly_json }}">
                </div>
            {% endif %}
        </div>

        <div class="text-xs text-gray-400 mt-2 px-2">
            {{ message.created_at|date:"H:i" }}
        </div>
    </div>
</div>