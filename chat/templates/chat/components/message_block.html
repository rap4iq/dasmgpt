{% comment %}
Этот data-message-id="{
    { message.id }}" КРИТИЧЕСКИ ВАЖЕН.
{% endcomment %}
<div class="message flex gap-4 mb-6 animate-fade-in {% if message.role == 'user' %}flex-row-reverse{% endif %}" data-message-id="{{ message.id }}">

    <!-- АВАТАР -->
    <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center shadow-sm
        {% if message.role == 'user' %} bg-blue-600 text-white {% else %} bg-gradient-to-br from-purple-500 to-blue-600 text-white {% endif %}">
        {% if message.role == 'user' %}
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        {% else %}
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962l6.135-1.583A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0l1.583 6.135a2 2 0 0 0 1.437 1.437l6.135 1.583a.5.5 0 0 1 0 .962l-6.135 1.583a2 2 0 0 0-1.437 1.437l-1.583 6.135a.5.5 0 0 1-.963 0z"/></svg>
        {% endif %}
    </div>

    <!-- КОНТЕНТ -->
    <div class="flex-1 max-w-[85%] {% if message.role == 'user' %}text-right{% endif %}">
        <!-- (ИЗМЕНЕНО) Логика классов для ширины -->
        <div class="px-5 py-3.5 rounded-2xl text-left shadow-sm
            {% if message.role == 'user' %}
                bg-blue-600 text-white rounded-tr-sm inline-block
            {% else %}
                bg-white border border-gray-100 text-gray-800 rounded-tl-sm
                {% if message.data_payload.plotly_json %} w-full block {% else %} inline-block {% endif %}
            {% endif %}">

            <!-- ТЕКСТ -->
            {% if message.role == 'ai' %}
                <div class="markdown-content prose max-w-none">{{ message.content }}</div>
            {% else %}
                <div class="whitespace-pre-wrap">{{ message.content }}</div>
            {% endif %}

            <!-- SQL / EXCEL -->
            {% if message.role == 'ai' and message.data_payload.sql_query %}
                <div class="mt-4 pt-3 border-t border-gray-100 flex flex-wrap items-center gap-2 not-prose">
                    <details class="group relative">
                        <summary class="cursor-pointer text-xs font-medium text-gray-500 hover:text-blue-600 flex items-center gap-1 select-none list-none">
                            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                            SQL
                        </summary>
                        <div class="absolute left-0 mt-2 w-64 bg-gray-800 text-gray-200 p-3 rounded-lg shadow-xl z-10 text-xs font-mono overflow-x-auto">
                            {{ message.data_payload.sql_query }}
                        </div>
                    </details>

                    <a href="{% url 'download_excel' message.id %}" class="inline-flex items-center gap-1 text-xs font-medium text-green-600 bg-green-50 hover:bg-green-100 px-2 py-1 rounded-md transition-colors border border-green-200 no-underline" target="_blank">
                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                        Excel
                    </a>
                </div>
            {% endif %}

            <!-- ГРАФИК -->
            {% if message.role == 'ai' and message.data_payload.plotly_json %}
                <!-- (ИЗМЕНЕНО) Убрали фиксированную ширину, пусть занимает 100% контейнера -->
                <div class="bot-chart chart-container-placeholder mt-4 not-prose w-full"
                     id="chart-{{ message.id }}"
                     data-plotly-json="{{ message.data_payload.plotly_json }}">
                </div>
            {% endif %}
        </div>

        <div class="text-xs text-gray-400 mt-1 px-1">
            {{ message.created_at|date:"H:i" }}
        </div>
    </div>
</div>