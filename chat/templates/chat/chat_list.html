<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{% if session %}{{ session.title }}{% else %}DasmGPT{% endif %}</title>
    <!-- 1. –ó–∞–≥—Ä—É–∂–∞–µ–º Plotly.js (–ê–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
    <script src="https://cdn.plot.ly/plotly-2.33.0.min.js"></script>
    <!-- 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 3. –°—Ç–∏–ª–∏ -->
    <style>
        /* --- –û–±—â–∏–µ –°—Ç–∏–ª–∏ --- */
        html {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #343541;
        }
        body {
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤) --- */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background-color: #202123;
            color: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }
        .sidebar-header {
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }
        .sidebar-header a.new-chat-btn {
            display: block;
            padding: 10px;
            background-color: #343541;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            text-align: center;
        }
        .sidebar-header a.new-chat-btn:hover {
            background-color: #444554;
        }

        .chat-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 15px;
        }
        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            text-decoration: none;
            color: white;
            justify-content: space-between;
        }
        .chat-list-item:hover, .chat-list-item.active {
            background-color: #343541;
        }
        .chat-list-item .chat-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }
        .chat-list-item .chat-actions {
            display: none;
            margin-left: 10px;
            flex-shrink: 0;
        }
        .chat-list-item:hover .chat-actions {
            display: flex;
        }
        .chat-actions button {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 4px;
        }
        .chat-actions button:hover {
            color: white;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        .sidebar-footer a {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            text-decoration: none;
            color: #ccc;
        }
        .sidebar-footer a:hover {
            background-color: #343541;
            color: white;
        }
        .sidebar-footer a svg {
            width: 18px;
            height: 18px;
            margin-right: 10px;
        }

        /* --- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–ê–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç) --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f7f7f8;
            overflow-x: hidden;
            min-width: 0;
        }

        .chat-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }
        .chat-header {
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        /* --- (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï CSS) --- */
        .messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 0;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }
        .message {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        .message:last-child {
            margin-bottom: 0;
        }
        /* --- (–ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø) --- */

        .user {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            max-width: 75%;
        }
        .bot {
            background-color: #ffffff;
            color: black;
            align-self: flex-start;
            border: 1px solid #e5e5e5;
            max-width: 100%;
        }

        .message-actions {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
            max-width: 100%;
            overflow: hidden;
        }
        .message-actions details {
            cursor: pointer;
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
        }
        .message-actions pre {
            max-width: 100%;
            overflow-x: auto;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 13px;
        }
        .excel-btn {
            font-size: 12px;
            padding: 4px 10px;
            background-color: #1D6F42;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 500;
            display: inline-block;
            margin-top: 5px;
        }
        .excel-btn:hover { background-color: #165231; }

        .bot-chart {
            width: 100%;
            height: 400px;
            background-color: #ffffff;
        }

        .form-container {
            display: flex;
            flex-shrink: 0;
            padding-top: 10px;
        }
        .form-container textarea {
            flex-grow: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: none;
        }
        .form-container button {
            padding: 10px 15px;
            margin-left: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .form-container button:disabled { background-color: #ccc; }
        #typing-indicator { display: none; margin-bottom: 10px; color: #777; font-style: italic; }
    </style>
</head>
<body>

    <!-- ======================= -->
    <!-- === –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ === -->
    <!-- ======================= -->
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="{% url 'new_chat' %}" class="new-chat-btn">+ –ù–æ–≤—ã–π —á–∞—Ç</a>
        </div>

        <div class="chat-list" id="chat-list-container">
            {% for s in sessions %}
                <!-- (–ò–°–ü–†–ê–í–õ–ï–ù–û) –ò—Å–ø–æ–ª—å–∑—É–µ–º public_id –≤–º–µ—Å—Ç–æ id -->
                <div id="session-{{ s.public_id }}">
                    <a href="{% url 'chat_detail' s.public_id %}"
                       class="chat-list-item {% if session and s.public_id == session.public_id %}active{% endif %}"
                       data-session-id="{{ s.public_id }}">

                        <span class="chat-title" id="title-{{ s.public_id }}">
                            {{ s.title }}
                        </span>

                        <div class="chat-actions">
                            <!-- (–ò–°–ü–†–ê–í–õ–ï–ù–û) URL-–∞–¥—Ä–µ—Å–∞ —Ç–µ–ø–µ—Ä—å —Å—Ç—Ä–æ—è—Ç—Å—è —á–µ—Ä–µ–∑ public_id -->
                            <button class="rename-btn"
                                    data-id="{{ s.public_id }}"
                                    data-url="{% url 'rename_chat' s.public_id %}"
                                    title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                            <button class="delete-btn"
                                    data-id="{{ s.public_id }}"
                                    data-url="{% url 'delete_chat' s.public_id %}"
                                    title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>

        <div class="sidebar-footer">
            <a href="{% url 'logout' %}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                  <path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 0 1 5.25 2h5.5A2.25 2.25 0 0 1 13 4.25v2a.75.75 0 0 1-1.5 0v-2A.75.75 0 0 0 10.75 3.5h-5.5A.75.75 0 0 0 4.5 4.25v11.5c0 .414.336.75.75.75h5.5a.75.75 0 0 0 .75-.75v-2a.75.75 0 0 1 1.5 0v2A2.25 2.25 0 0 1 10.75 18h-5.5A2.25 2.25 0 0 1 3 15.75V4.25Z" clip-rule="evenodd" />
                  <path fill-rule="evenodd" d="M16.72 9.22a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1 0 1.06l-2.25 2.25a.75.75 0 1 1-1.06-1.06L17.94 12l-1.22-1.22a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                  <path fill-rule="evenodd" d="M11.75 12a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 0 1.5h-5.5a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
                </svg>
                –í—ã–π—Ç–∏
            </a>
        </div>
    </div>

    <!-- ======================= -->
    <!-- === –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ === -->
    <!-- ======================= -->
    <div class="main-content">

        {% if not session %}
            <div class="chat-container">
                <div class="chat-header">
                    <h2 class="text-2xl font-semibold">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ DasmGPT</h2>
                </div>
                <div class="messages" style="align-items: center; justify-content: center;">
                    <p class="text-gray-600">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</p>
                </div>
            </div>

        {% else %}
            <!-- –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –≤—ã–±—Ä–∞–Ω–∞, –≤—Å—Ç–∞–≤–ª—è–µ–º HTML —á–∞—Ç–∞ -->
            <div class="chat-container">
                <div class="chat-header">
                    <h2 class="text-2xl font-semibold" id="chat-title-header">{{ session.title }}</h2>
                </div>

                <div class="messages" id="message-list">
                    {% for msg in messages %}
                        {% include 'chat/components/message_block.html' with message=msg %}
                    {% endfor %}
                </div>

                <div id="typing-indicator">DasmGPT –ø–µ—á–∞—Ç–∞–µ—Ç...</div>

                <form id="chat-form" class="form-container">
                    {% csrf_token %}
                    <textarea id="message-input" name="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                    <button id="send-button" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </form>
            </div>
        {% endif %}
    </div>


    <!-- ======================= -->
    <!-- === JAVASCRIPT === -->
    <!-- ======================= -->
    <script>
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // ------------------------------------
        // --- –°–ö–†–ò–ü–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ß–ê–¢–ê–ú–ò ---
        // ------------------------------------
        document.getElementById('chat-list-container').addEventListener('click', function(e) {

            const renameButton = e.target.closest('.rename-btn');
            if (renameButton) {
                e.preventDefault();
                e.stopPropagation();

                const sessionId = renameButton.dataset.id;
                const renameUrl = renameButton.dataset.url;
                const titleSpan = document.getElementById(`title-${sessionId}`);
                const currentTitle = titleSpan.innerText;

                const newTitle = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:", currentTitle);

                if (newTitle && newTitle !== currentTitle) {
                    fetch(renameUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ new_title: newTitle })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            titleSpan.innerText = data.new_title;
                            const headerTitle = document.getElementById('chat-title-header');
                            // (–ò–°–ü–†–ê–í–õ–ï–ù–û) –°—Ä–∞–≤–Ω–µ–Ω–∏–µ public_id
                            if (headerTitle && "{{ session.public_id|default:'' }}" === sessionId) {
                                headerTitle.innerText = data.new_title;
                            }
                        } else {
                            alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è: ' + data.message);
                        }
                    });
                }
            }

            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                e.preventDefault();
                e.stopPropagation();

                const sessionId = deleteButton.dataset.id;
                const deleteUrl = deleteButton.dataset.url;

                if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?")) {
                    fetch(deleteUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            document.getElementById(`session-${sessionId}`).remove();
                            // (–ò–°–ü–†–ê–í–õ–ï–ù–û) –°—Ä–∞–≤–Ω–µ–Ω–∏–µ public_id
                            if ("{{ session.public_id|default:'' }}" === sessionId) {
                                window.location.href = data.redirect_url || '/';
                            }
                        } else {
                            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.message);
                        }
                    });
                }
            }
        });

        // ----------------------------------------------------
        // --- –°–ö–†–ò–ü–¢–´ –û–¢–ü–†–ê–í–ö–ò –°–û–û–ë–©–ï–ù–ò–ô –ò –†–ï–ù–î–ï–†–ò–ù–ì–ê –ì–†–ê–§–ò–ö–û–í ---
        // ----------------------------------------------------

        {% if session %}
        (function() {
            const messageList = document.getElementById('message-list');
            const messageInput = document.getElementById('message-input');
            const chatForm = document.getElementById('chat-form');
            const sendButton = document.getElementById('send-button');
            const typingIndicator = document.getElementById('typing-indicator');

            // (–ò–°–ü–†–ê–í–õ–ï–ù–û) –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ public_id –≤ URL
            const sendUrl = "{% url 'send_message' session.public_id %}";
            const getUrl = "{% url 'get_new_messages' session.public_id %}";

            let pollingInterval;
            let lastMessageId = 0;

            // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
            function renderChartsInElement(containerElement) {
                const chartPlaceholders = containerElement.querySelectorAll('.chart-container-placeholder');
                chartPlaceholders.forEach(placeholder => {
                    const plotlyJson = placeholder.dataset.plotlyJson;
                    if (plotlyJson) {
                        try {
                            const chartData = JSON.parse(plotlyJson);
                            const chartId = placeholder.id;
                            Plotly.newPlot(chartId, chartData.data, chartData.layout, {
                                responsive: true,
                                displaylogo: false,
                                modeBarButtonsToRemove: ['sendDataToCloud']
                            });
                            placeholder.removeAttribute('data-plotly-json');
                        } catch (e) {
                            console.error("–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ Plotly:", e, plotlyJson);
                        }
                    }
                });
            }

            document.addEventListener('DOMContentLoaded', () => {
                scrollToBottom();
                const lastMsg = messageList.querySelector('.message:last-child');
                if (lastMsg) {
                    lastMessageId = parseInt(lastMsg.dataset.messageId || '0');
                }
                renderChartsInElement(messageList);
            });

            chatForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const messageText = messageInput.value.trim();
                if (!messageText) return;
                setLoadingState(true);

                fetch(sendUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify({ message: messageText })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'processing') {
                        const newMsgEl = addMessageHtml(data.user_message_html);
                        startPolling();
                    } else {
                        setLoadingState(false);
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                    setLoadingState(false);
                });
            });

            function setLoadingState(isLoading) {
                messageInput.disabled = isLoading;
                sendButton.disabled = isLoading;
                typingIndicator.style.display = isLoading ? 'block' : 'none';
                if (isLoading) messageInput.value = '';
            }

            function startPolling() {
                if (pollingInterval) return;
                pollingInterval = setInterval(() => {
                    fetch(`${getUrl}?last_message_id=${lastMessageId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                stopPolling();
                                const newMsgEl = addMessageHtml(data.message_html);
                                renderChartsInElement(newMsgEl);
                            }
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ "–æ–ø—Ä–æ—Å–∞":', error);
                            stopPolling();
                        });
                }, 2500);
            }

            function stopPolling() {
                clearInterval(pollingInterval);
                pollingInterval = null;
                setLoadingState(false);
            }

            function addMessageHtml(html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const newMsgEl = tempDiv.firstElementChild;
                messageList.appendChild(newMsgEl);

                const lastMsg = messageList.querySelector('.message:last-child');
                if (lastMsg) {
                    lastMessageId = parseInt(lastMsg.dataset.messageId || '0');
                }
                scrollToBottom();
                return newMsgEl;
            }

            function scrollToBottom() {
                messageList.scrollTop = messageList.scrollHeight;
            }
        })();
        {% endif %}
        // ------------------------------------

    </script>
</body>
</html>